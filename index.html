<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Quiz Demo</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121826; --muted:#8aa0b4; --text:#e6edf3; --accent:#6ee7b7; --accent-2:#60a5fa; --danger:#f87171; --ok:#34d399;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b0f19,#0b1222 30%,#0e1324); color:var(--text);}
    .container{max-width:880px;margin:0 auto;padding:24px}
    .card{background:var(--card); border:1px solid #1f2937;border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .badge{font-size:12px;color:#0f172a;background:#e2e8f0;border-radius:999px;padding:4px 10px}
    .muted{color:var(--muted)}
    button{appearance:none;cursor:pointer;border:1px solid #2b3648;background:#121826;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:600}
    button.primary{background:linear-gradient(90deg,var(--accent-2),#7c3aed); border-color:transparent}
    button.ghost{background:transparent;border-color:#2b3648}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    .center{display:flex;align-items:center;justify-content:center}
    .progress{height:10px;background:#111827;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#22d3ee,#22c55e);width:0%}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0f172a;border:1px solid #263244;color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:12px}
    .q-title{font-size:20px;font-weight:700;margin:6px 0 14px}
    .option{display:flex;gap:10px;align-items:flex-start;border:1px solid #263244;background:#0f172a;border-radius:12px;padding:12px;cursor:pointer}
    .option input{margin-top:2px}
    .option.correct{border-color:#16a34a;background:#062313}
    .option.wrong{border-color:#b91c1c;background:#230606}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
    .footer{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0a1020;border:1px solid #263244;padding:8px;border-radius:8px;white-space:pre-wrap}
    .hidden{display:none !important}
    .score{font-size:34px;font-weight:800}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2b3648}
    .ok{color:#10b981;border-color:#10b98130;background:#06351f}
    .ng{color:#ef4444;border-color:#ef444430;background:#3a0a0a}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;border:1px solid #334155;padding:.5px 6px;border-radius:6px;background:#0b1222}
    a{color:#93c5fd}
    .input{background:#0f172a;border:1px solid #263244;color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:12px;outline:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="brand">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.32L12 14.77 7.22 16.7l.91-5.32L4.27 7.62l5.34-.78L12 2z" fill="url(#g)"/><defs><linearGradient id="g" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#60a5fa"/><stop offset="1" stop-color="#7c3aed"/></linearGradient></defs></svg>
          <div>
            <div style="font-weight:800">AI Quiz Demo</div>
            <div class="muted" id="envInfo">æ­£åœ¨æ£€æµ‹ç¯å¢ƒâ€¦</div>
          </div>
        </div>
        <div class="row">
          <span class="pill" id="timer">â±ï¸ 00:00</span>
          <span class="pill" id="progressText">0 / 0</span>
        </div>
      </header>

      <div class="progress" aria-label="è¿›åº¦">
        <div class="bar" id="bar"></div>
      </div>

      <!-- å¯é€‰ï¼šåŸºç¡€ä¿¡æ¯è¾“å…¥ -->
      <div class="row" style="margin:10px 0 0">
        <input class="input" id="nameInput" placeholder="å§“åï¼ˆå¯é€‰ï¼‰" />
        <input class="input" id="sidInput" placeholder="å­¦å·ï¼ˆå¯é€‰ï¼‰" />
        <input class="input" id="classInput" placeholder="ç­çº§ï¼ˆå¯é€‰ï¼‰" />
      </div>

      <main id="stage" style="margin-top:16px"></main>

      <div class="footer">
        <div class="row">
          <button class="ghost" id="btnPrev">â† ä¸Šä¸€é¢˜</button>
          <button class="primary" id="btnNext">ä¸‹ä¸€é¢˜ â†’</button>
        </div>
        <div class="row">
          <button class="ghost" id="btnReset">é‡åš</button>
          <button class="ghost" id="btnExport">å¯¼å‡ºCSV</button>
        </div>
      </div>
    </div>

    <p class="muted" style="margin:14px 6px 0">ğŸ’¡ æç¤ºï¼šæäº¤åä¼šæŠŠæˆç»©é€šè¿‡ä½ çš„ Worker å†™å…¥é£ä¹¦å¤šç»´è¡¨æ ¼ã€‚</p>

    <details style="margin-top:16px">
      <summary>å¦‚ä½•è‡ªå®šä¹‰é¢˜åº“ / æˆç»©ä¸ŠæŠ¥ï¼Ÿï¼ˆå±•å¼€æŸ¥çœ‹ï¼‰</summary>
      <div class="card" style="margin-top:10px">
        <div class="q-title">1ï¼‰ç¼–è¾‘é¢˜åº“ï¼ˆåœ¨ä»£ç é¡¶éƒ¨çš„ <span class="kbd">QUESTIONS</span>ï¼‰</div>
        <div class="code" id="docQuestions"></div>
        <div class="q-title">2ï¼‰é£ä¹¦å†…åµŒ</div>
        <p>Cloudflare Pages æ ¹ç›®å½•æ”¾ç½® <span class="kbd">_headers</span> æ–‡ä»¶ï¼š</p>
        <div class="code">/*\n  X-Frame-Options:\n  Content-Security-Policy: frame-ancestors https://*.feishu.cn https://*.larksuite.com https://*.feishu-ptt.cn https://*.larkoffice.com;\n</div>
      </div>
    </details>
  </div>

  <script>
  // ==================== é…ç½®åŒº ====================
  // å·²æ›¿æ¢ä¸ºä½ çš„ Worker æ ¹åœ°å€ï¼ˆæ— å°¾éƒ¨æ–œæ ï¼‰
  const WORKER_BASE = 'https://ai-quiz-api.shenyoujuan387.workers.dev';
  // æäº¤åˆ° Worker çš„ /bitable/write
  window.WEBHOOK_URL = WORKER_BASE ? `${WORKER_BASE}/bitable/write` : "";

  // é¢˜åº“ç¤ºä¾‹
  const QUESTIONS = [
    { id:"q1", type:"mc",  points:1, stem:"ä¸‹åˆ—å“ªä¸€é¡¹å±äºå…ƒéŸ³ï¼Ÿ", options:["b","a","t","k"], answer:1, hint:"æƒ³æƒ³ a e i o u" },
    { id:"q2", type:"tf",  points:1, stem:"è‹±æ–‡å¥å­é¦–å­—æ¯é€šå¸¸éœ€è¦å¤§å†™ã€‚", answer:true },
    { id:"q3", type:"mc",  points:2, stem:"é€‰æ‹©ä¸å›¾ç‰‡æ„æ€ç›¸åŒçš„å•è¯ï¼ˆå‡è®¾å›¾ç‰‡æ˜¯ä¸€åªçŒ«ï¼‰", options:["dog","cat","bird","fish"], answer:1 },
    { id:"q4", type:"text",points:2, stem:"æŠŠ â€˜Good afternoonâ€™ æ­£ç¡®æŠ„å†™åˆ°è¾“å…¥æ¡†ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰", answer:"Good afternoon", hint:"ä¸¤ä¸ªå•è¯ï¼Œé¦–å­—æ¯éœ€å¤§å†™" },
    { id:"q5", type:"mc",  points:2, stem:"Which one is a greeting?", options:["banana","table","hello","blue"], answer:2 }
  ];

  // ==================== çŠ¶æ€ & å·¥å…· ====================
  const $ = sel => document.querySelector(sel);
  const stage = $('#stage');
  const btnPrev = $('#btnPrev');
  const btnNext = $('#btnNext');
  const btnReset = $('#btnReset');
  const btnExport = $('#btnExport');
  const bar = $('#bar');
  const progressText = $('#progressText');
  const timerEl = $('#timer');
  const envInfo = $('#envInfo');

  const attemptId = (()=>{
    const rnd = Math.random().toString(36).slice(2,8);
    const ts = new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14);
    return `A${ts}-${rnd}`;
  })();

  const state = {
    startedAt: Date.now(),
    idx: 0,
    answers: {},
    review: {},
    finished: false,
  };

  function fmtTime(ms){
    const s = Math.floor(ms/1000); const m = Math.floor(s/60); const ss = s%60;
    return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }

  function tick(){ timerEl.textContent = `â±ï¸ ${fmtTime(Date.now()-state.startedAt)}`; requestAnimationFrame(tick) }
  requestAnimationFrame(tick);

  function detectEnv(){
    const isIframe = window.top !== window.self;
    const ua = navigator.userAgent;
    const inFeishu = /Lark|Feishu/i.test(ua) || (isIframe && document.referrer.includes('feishu'));
    envInfo.textContent = inFeishu? 'é£ä¹¦å†…åµŒç¯å¢ƒå·²æ£€æµ‹åˆ° âœ“' : 'ç‹¬ç«‹æµè§ˆå™¨ç¯å¢ƒ';
  }
  detectEnv();

  function shuffle(arr){
    return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  }

  const questions = shuffle(QUESTIONS.map(q=>({...q})));

  // ==================== æ¸²æŸ“é¢˜ç›® ====================
  function render(){
    const total = questions.length;
    progressText.textContent = `${Math.min(state.idx+1,total)} / ${total}`;
    bar.style.width = `${(state.idx)/Math.max(1,total)*100}%`;

    if(state.finished){
      return renderSummary();
    }

    const q = questions[state.idx];
    const saved = state.answers[q.id];

    let html = `<div class="pill">é¢˜å·ï¼š${state.idx+1} / ${total} Â· åˆ†å€¼ ${q.points}</div>`;
    html += `<div class="q-title">${escapeHtml(q.stem)}</div>`;

    if(q.type === 'mc'){
      html += `<div class="grid">`;
      q.options.forEach((opt,i)=>{
        const checked = saved === i ? 'checked' : '';
        html += `
          <label class="option">
            <input type="radio" name="opt" value="${i}" ${checked} />
            <div>${escapeHtml(opt)}</div>
          </label>`;
      })
      html += `</div>`;
      if(q.hint) html += `<div class="muted" style="margin-top:6px">æç¤ºï¼š${escapeHtml(q.hint)}</div>`;
    }

    if(q.type === 'tf'){
      const yes = saved === true ? 'checked' : '';
      const no  = saved === false ? 'checked' : '';
      html += `
      <div class="row">
        <label class="option grow"><input type="radio" name="tf" value="true" ${yes}/> æ­£ç¡®</label>
        <label class="option grow"><input type="radio" name="tf" value="false" ${no}/> é”™è¯¯</label>
      </div>`;
    }

    if(q.type === 'text'){
      const val = typeof saved === 'string'? saved : '';
      html += `<input id="txt" class="option grow" style="padding:12px" placeholder="è¯·è¾“å…¥ç­”æ¡ˆâ€¦" value="${escapeHtml(val)}"/>`;
      if(q.hint) html += `<div class="muted" style="margin-top:6px">æç¤ºï¼š${escapeHtml(q.hint)}</div>`;
    }

    stage.innerHTML = html;

    // ç»‘å®šäº¤äº’
    stage.querySelectorAll('input[name="opt"]').forEach(el=>{
      el.addEventListener('change',()=>{
        state.answers[q.id] = Number(el.value);
        saveLocal();
      })
    });
    stage.querySelectorAll('input[name="tf"]').forEach(el=>{
      el.addEventListener('change',()=>{
        state.answers[q.id] = (el.value === 'true');
        saveLocal();
      })
    });
    const txt = stage.querySelector('#txt');
    if(txt) txt.addEventListener('input',()=>{ state.answers[q.id] = txt.value; saveLocal(); });

    btnPrev.disabled = state.idx===0;
    btnNext.textContent = state.idx === total-1 ? 'æäº¤å¹¶æŸ¥çœ‹ç»“æœ âœ“' : 'ä¸‹ä¸€é¢˜ â†’';
  }

  btnPrev.addEventListener('click',()=>{ if(state.idx>0){ state.idx--; render(); } });
  btnNext.addEventListener('click',()=>{
    if(state.idx < questions.length-1){ state.idx++; render(); return; }
    // æäº¤å¹¶è®¡åˆ†
    evaluate();
    state.finished = true; saveLocal(); render();
    // ä¸Šä¼ åˆ°é£ä¹¦ï¼ˆé€šè¿‡ä½ çš„ Workerï¼‰
    if (window.WEBHOOK_URL) { postToFeishu().catch(console.error); }
  });

  btnReset.addEventListener('click',()=>{
    if(confirm('ç¡®å®šè¦é‡åšå—ï¼Ÿå½“å‰ä½œç­”å°†è¢«æ¸…ç©ºã€‚')){
      localStorage.removeItem(lsKey());
      location.reload();
    }
  });

  btnExport.addEventListener('click',()=>{
    const csv = toCSV(payload());
    download(`quiz_${attemptId}.csv`, csv);
  });

  function evaluate(){
    let total=0, got=0; const review={};
    questions.forEach(q=>{
      total += q.points;
      let correct=false;
      const v = state.answers[q.id];
      if(q.type==='mc'){ correct = (v===q.answer) }
      if(q.type==='tf'){ correct = (v===q.answer) }
      if(q.type==='text'){ correct = (String(v||'').trim() === String(q.answer).trim()) }
      const score = correct? q.points: 0;
      if(correct) got += q.points;
      review[q.id] = {correct, score};
    });
    state.review = review; state.totalPoints = total; state.gotPoints = got;
  }

  function renderSummary(){
    const percent = Math.round((state.gotPoints/state.totalPoints)*100);
    const used = fmtTime(Date.now()-state.startedAt);
    bar.style.width = '100%';

    let html = `<div class="center" style="gap:14px;flex-direction:column">`+
      `<div class="score">${percent}%</div>`+
      `<div class="row"><span class="tag ok">å¾—åˆ† ${state.gotPoints} / ${state.totalPoints}</span><span class="tag">ç”¨æ—¶ ${used}</span><span class="tag">å°è¯•ID ${attemptId}</span></div>`+
      `</div>`;

    html += `<h3 style="margin-top:18px">é¢˜ç›®å›é¡¾</h3>`;
    questions.forEach((q,i)=>{
      const r = state.review[q.id];
      html += `<div class="option ${r.correct?'correct':'wrong'}" style="margin-top:8px">`+
        `<div class="grow"><div style="font-weight:700">${i+1}. ${escapeHtml(q.stem)}</div>`+
        `<div class="muted">ä½ çš„ç­”æ¡ˆï¼š${formatUserAns(q, state.answers[q.id])}</div>`+
        `<div class="muted">æ­£ç¡®ç­”æ¡ˆï¼š${formatCorrect(q)}</div>`+
        `</div>`+
        `<div style="font-weight:800">${r.score} / ${q.points}</div>`+
      `</div>`;
    })

    stage.innerHTML = html;
    btnPrev.disabled = true; btnNext.disabled = true;
  }

  function lsKey(){ return `quiz-demo-v1` }
  function saveLocal(){ localStorage.setItem(lsKey(), JSON.stringify({attemptId, state})) }
  function loadLocal(){
    const raw = localStorage.getItem(lsKey());
    if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      if(obj && obj.state){ Object.assign(state, obj.state); }
    }catch{}
  }

  function payload(){
    const answers = questions.map(q=>({
      id:q.id, type:q.type, stem:q.stem,
      user: state.answers[q.id] ?? null,
      correct: (state.review[q.id]?.correct ?? null),
      score: (state.review[q.id]?.score ?? 0),
      points: q.points
    }));
    return {
      attemptId,
      startedAt: new Date(state.startedAt).toISOString(),
      finishedAt: new Date().toISOString(),
      totalPoints: state.totalPoints ?? null,
      gotPoints: state.gotPoints ?? null,
      percent: state.totalPoints? Math.round((state.gotPoints/state.totalPoints)*100) : null,
      userAgent: navigator.userAgent,
      referrer: document.referrer,
      location: location.href,
      answers
    };
  }

  // æäº¤åˆ°ä½ çš„ Worker â†’ é£ä¹¦å¤šç»´è¡¨æ ¼
  async function postToFeishu(){
    try{
      const name = $('#nameInput')?.value?.trim() || 'æœªå¡«';
      const sid  = $('#sidInput')?.value?.trim()  || attemptId;
      const cls  = $('#classInput')?.value?.trim()|| '';
      const fields = {
        "å§“å": name,
        "å­¦å·": sid,
        "ç­çº§": cls,
        "å¾—åˆ†": Number(state.gotPoints || 0),
        "æäº¤æ—¶é—´": new Date().toISOString(),
        "è®¾å¤‡": navigator.userAgent,
        "éŸ³é¢‘URL": ""
      };
      const res = await fetch(window.WEBHOOK_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ fields })
      });
      const data = await res.json();
      console.log('Feishu write', data);
      if(!data.ok){ alert('å†™å…¥é£ä¹¦å¤±è´¥ï¼š' + JSON.stringify(data)); }
    }catch(err){
      console.warn('Feishu write error', err);
      alert('å†™å…¥é£ä¹¦å¤±è´¥ï¼ˆç½‘ç»œ/è·¨åŸŸï¼‰ã€‚');
    }
  }

  // ==================== å°å·¥å…· ====================
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }
  function formatUserAns(q, v){
    if(q.type==='mc'){ return escapeHtml(q.options[Number(v)] ?? 'æœªä½œç­”') }
    if(q.type==='tf'){ return v===true? 'æ­£ç¡®' : v===false? 'é”™è¯¯' : 'æœªä½œç­”' }
    if(q.type==='text'){ return v? `<span class="kbd">${escapeHtml(v)}</span>` : 'æœªä½œç­”' }
  }
  function formatCorrect(q){
    if(q.type==='mc'){ return escapeHtml(q.options[q.answer]) }
    if(q.type==='tf'){ return q.answer? 'æ­£ç¡®':'é”™è¯¯' }
    if(q.type==='text'){ return `<span class="kbd">${escapeHtml(q.answer)}</span>` }
  }
  function toCSV(obj){
    const rows = [
      ['attemptId','startedAt','finishedAt','totalPoints','gotPoints','percent','userAgent','referrer','location'],
      [obj.attemptId,obj.startedAt,obj.finishedAt,obj.totalPoints,obj.gotPoints,obj.percent,obj.userAgent,obj.referrer,obj.location],
      [],
      ['id','type','points','score','correct','stem','user'],
      ...obj.answers.map(a=>[a.id,a.type,a.points,a.score,a.correct, a.stem.replace(/\n/g,' '), JSON.stringify(a.user)])
    ];
    return rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  }
  function download(name, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text],{type:'text/csv'}));
    a.download = name; a.click(); URL.revokeObjectURL(a.href);
  }

  // ==================== åˆå§‹åŒ– ====================
  loadLocal();
  render();

  // æ–‡æ¡£ç¤ºä¾‹å—
  $('#docQuestions').textContent = JSON.stringify(QUESTIONS, null, 2);
  $('#docPayload').textContent = JSON.stringify(payload(), null, 2);
  </script>
</body>
</html>
