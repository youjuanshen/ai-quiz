// ğŸ”‘ æ­¥éª¤ 1: å®šä¹‰ Google Sheet é“¾æ¥å’Œé…ç½®
// æ‚¨çš„â€œæµ‹éªŒé¢˜åº“â€ Google Sheet ID
const SHEET_ID = '1fov6b9Py6GtdUCOAe0-VjrzI-yYxuKWEIuf0_ouzqH8'; 
// æ‚¨çš„ Make.com Webhook URL
const WEBHOOK_URL = "https://hook.eu1.make.com/5nx5elyzjbbi8hujod7f4s6whmgthqc5"; 
const GID = '0'; // é€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨çš„ ID
const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;

// å…¨å±€å˜é‡ç”¨äºå­˜å‚¨åŠ è½½çš„é¢˜ç›®æ•°æ®å’Œæ­£ç¡®ç­”æ¡ˆ
let QUIZ_DATA = [];
let CORRECT_ANSWERS = {};
const SCORE_PER_QUESTION = 5; // æ¯é¢˜ 5 åˆ†

// ----------------------------------------------------
// æ ¸å¿ƒå‡½æ•° - åŠ è½½å¹¶è§£æ Google Sheet æ•°æ® (å·²ä¼˜åŒ– CSV æ¸…ç†)
// ----------------------------------------------------
async function loadQuizData() {
    const quizForm = document.getElementById('quizForm');
    const startBtn = document.getElementById('startBtn');
    
    // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    startBtn.disabled = true;
    startBtn.textContent = 'åŠ è½½é¢˜åº“ä¸­...';
    quizForm.innerHTML = ''; // æ¸…ç©ºåŸæœ‰ç¡¬ç¼–ç é¢˜ç›®

    try {
        const response = await fetch(GOOGLE_SHEET_URL);
        const csvText = await response.text();
        
        // æ ¸å¿ƒä¼˜åŒ–ï¼šæ›´ä¸¥æ ¼çš„ CSV è§£æå’Œæ¸…ç†
        const lines = csvText.trim().split('\n');
        
        // 1. æ¸…ç†å¹¶æ ‡å‡†åŒ– Headers
        const headers = lines[0].split(',')
            .map(h => h.replace(/"/g, '').trim()) // ç§»é™¤å¼•å·å¹¶ä¿®å‰ªç©ºæ ¼
            .filter(h => h.length > 0); // ç§»é™¤ç©ºåˆ—å

        if (lines.length <= 1 || headers.length < 5) {
             // å¦‚æœåªæœ‰è¡¨å¤´æˆ–è¡¨å¤´ä¸å®Œæ•´ï¼Œè§†ä¸ºåŠ è½½å¤±è´¥
             throw new Error('CSV data is empty or malformed.');
        }

        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const question = {};
            
            for (let j = 0; j < headers.length; j++) {
                // 2. æ¸…ç†å¹¶æ˜ å°„ Values
                question[headers[j]] = (values[j] || '').replace(/"/g, '').trim(); 
            }
            
            // åªæœ‰åŒ…å« Question_ID çš„æœ‰æ•ˆè¡Œæ‰è¢«è§†ä¸ºé¢˜ç›®
            if (question.Question_ID) {
                QUIZ_DATA.push(question);
                CORRECT_ANSWERS[question.Question_ID] = question.Correct_Answer;
            }
        }
        
        // å¦‚æœæ²¡æœ‰åŠ è½½åˆ°ä»»ä½•æœ‰æ•ˆé¢˜ç›®ï¼Œä¹Ÿè§†ä¸ºå¤±è´¥
        if (QUIZ_DATA.length === 0) {
             throw new Error('No valid questions found in the sheet data.');
        }

        // æ¸²æŸ“é¢˜ç›®å¹¶æ›´æ–° UI
        renderQuiz();
        document.getElementById('qCount').textContent = QUIZ_DATA.length;
        startBtn.textContent = 'å¼€å§‹ç»ƒä¹ ';
        startBtn.disabled = false;
        
    } catch (error) {
        console.error('Error loading quiz data from Google Sheet:', error);
        quizForm.innerHTML = '<p style="color: red;">âŒ æ— æ³•åŠ è½½é¢˜åº“ï¼Œè¯·æ£€æŸ¥ Google Sheet æ•°æ®æˆ–é“¾æ¥/æƒé™ã€‚</p>';
        startBtn.textContent = 'åŠ è½½å¤±è´¥';
    }
}


// ----------------------------------------------------
// æ¸²æŸ“é¢˜ç›®åˆ° HTML é¡µé¢
// ----------------------------------------------------
function renderQuiz() {
    const quizForm = document.getElementById('quizForm');
    
    let htmlContent = '';
    let currentPart = ''; 

    QUIZ_DATA.forEach((q, index) => {
        // å¦‚æœ Part å­—æ®µæ”¹å˜ï¼Œæ·»åŠ æ–°çš„æ¨¡å—æ ‡é¢˜ (L/R/W)
        if (q.Part && q.Part !== currentPart) {
            currentPart = q.Part;
            // å‡è®¾ Part å­—æ®µå°±æ˜¯ L, R, W
            const partMap = { 'L': 'å¬åŠ› (Listening)', 'R': 'é˜…è¯» (Reading)', 'W': 'å†™ä½œ (Writing)', 'S': 'å£è¯­ (Speaking)' };
            htmlContent += `<h2>Part ${q.Part}: ${partMap[q.Part] || q.Part} æ¨¡å— (æ¯é¢˜ ${SCORE_PER_QUESTION} åˆ†)</h2><hr>`;
        }

        // é¢˜å¹² (Question Text)
        htmlContent += `<div class="question" data-id="${q.Question_ID}">`;
        htmlContent += `<p>${index + 1}. ${q.Question_Text}</p>`;
        
        // æ¸²æŸ“é€‰é¡¹ (Option 1 åˆ° Option 5)
        for (let i = 1; i <= 5; i++) {
            const optionKey = `Option_${i}`;
            const optionValue = q[optionKey];
            
            if (optionValue && optionValue.trim() !== '') {
                // ä½¿ç”¨é€‰é¡¹ç¼–å· (i) ä½œä¸º value
                htmlContent += `<label><input type="radio" name="${q.Question_ID}" value="${i}"> ${optionValue}</label><br>`;
            }
        }
        htmlContent += `</div>`;
    });

    // æ¸²æŸ“åŠ¨æ€ç”Ÿæˆçš„é¢˜ç›®
    quizForm.innerHTML = htmlContent;

    // æ·»åŠ å›ºå®šçš„ç®€ç­”é¢˜å’Œæäº¤æŒ‰é’® (ç¡®ä¿æäº¤æŒ‰é’®åœ¨ form å†…)
    quizForm.innerHTML += `
        <label for="answer_raw">ğŸ“ ç®€ç­”/ä½œæ–‡ (AIè¯„è¯­çš„ä¾æ®):</label>
        <textarea id="answer_raw" name="Answer_Raw" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘è§‰å¾—è¿™äº›é¢˜å¾ˆç®€å•ï¼Œå…¨éƒ¨éƒ½åšå¯¹äº†ã€‚" required></textarea>
        <button type="submit">æäº¤å¹¶å½’æ¡£æˆç»©</button>
    `;
    
    // é‡æ–°ç»‘å®šæäº¤äº‹ä»¶
    document.getElementById('quizForm').removeEventListener('submit', handleSubmit);
    document.getElementById('quizForm').addEventListener('submit', handleSubmit);
}


// ----------------------------------------------------
// æäº¤äº‹ä»¶å¤„ç†å‡½æ•°
// ----------------------------------------------------
function handleSubmit(event) {
    event.preventDefault(); 

    const form = event.target;
    const lessonID = document.getElementById('lessonID_input').value.trim();
    const studentId = document.getElementById('studentId').value;
    const answerRawText = document.getElementById('answer_raw').value;

    // 0. å…³é”®æ•°æ®æ£€æŸ¥
    if (!lessonID || lessonID.includes('è¯·å¡«å†™')) {
        return alert('âŒ è¯·å¡«å†™å”¯ä¸€çš„è¯¾ç¨‹/å‘¨æ¬¡ IDï¼Œè¿™æ˜¯ AI å½’æ¡£çš„å…³é”®ï¼');
    }
    if (!studentId) {
        return alert('âŒ è¯·é€‰æ‹©ä½ çš„åå­—ï¼');
    }

    // 1. è‡ªåŠ¨åˆ¤å®¢è§‚é¢˜å¾—åˆ† - ç»†åˆ†åˆ° L/R/W
    let L_Score = 0; 
    let R_Score = 0; 
    let W_Score = 0; 
    let Grand_Total = 0; 
    let answerRaw = {}; // å­˜å‚¨å­¦ç”Ÿä½œç­”åŸå§‹è®°å½•

    QUIZ_DATA.forEach(q => {
        const questionId = q.Question_ID;
        const correctAnswer = CORRECT_ANSWERS[questionId];
        const selectedAnswer = form.elements[questionId] ? form.elements[questionId].value : null;

        // è®°å½•ä½œç­”
        answerRaw[questionId] = selectedAnswer;

        if (selectedAnswer === correctAnswer && selectedAnswer !== null) { // å¢åŠ  null æ£€æŸ¥ï¼Œç¡®ä¿ç”¨æˆ·æœ‰é€‰æ‹©
            Grand_Total += SCORE_PER_QUESTION;
            
            // æ ¹æ® Part å­—æ®µåˆ’åˆ†ç»†åˆ†åˆ†æ•°
            if (q.Part === 'L') { 
                L_Score += SCORE_PER_QUESTION;
            } else if (q.Part === 'R') { 
                R_Score += SCORE_PER_QUESTION;
            } else if (q.Part === 'W') { 
                W_Score += SCORE_PER_QUESTION;
            }
        }
    });

    // 2. å‡†å¤‡å‘é€ç»™ Make.com çš„æ•°æ®
    const dataToSend = {
        Lesson_ID: lessonID,
        Student_ID: studentId,
        Answer_Raw: answerRawText, // å‘é€ç®€ç­”/ä½œæ–‡åŸæ–‡
        L_Score: L_Score,
        R_Score: R_Score,
        W_Score: W_Score,
        S_Score: 0, // å£è¯­æ¨¡å—æš‚ä¸è®¡åˆ†
        Grand_Total: Grand_Total
    };

    // 3. é”å®šè¡¨å•å¹¶å‘é€æ•°æ®
    const submitButton = document.querySelector('button[type="submit"]');
    submitButton.textContent = 'æ­£åœ¨æäº¤...';
    submitButton.disabled = true;

    fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataToSend)
    })
    .then(response => {
        if (response.ok) {
            alert(`âœ… æäº¤æˆåŠŸï¼å®¢è§‚é¢˜å¾—åˆ†ï¼š${Grand_Total} åˆ†ã€‚æ•°æ®å·²å½’æ¡£åˆ° Make.comã€‚`);
            submitButton.textContent = 'æäº¤æˆåŠŸ';
        } else {
            alert("âŒ æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Make.com Webhook æˆ–ç½‘ç»œã€‚");
            submitButton.textContent = 'æäº¤å¤±è´¥';
        }
    })
    .catch(error => {
        console.error('å‘é€è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
        alert('âŒ å‘é€è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚');
        submitButton.textContent = 'æäº¤å¤±è´¥';
    });
}


// å¯åŠ¨å‡½æ•°ï¼šé¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
window.onload = function() {
    loadQuizData();
};
