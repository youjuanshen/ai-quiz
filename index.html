<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>English Adventure (iOS 12 Safe)</title>
    
    <!-- 1. POLYFILLS (Crucial for iOS 12 / Safari 12) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.33.2/minified.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regenerator-runtime/0.14.0/runtime.min.js"></script>

    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'Helvetica Neue', 'sans-serif'] },
                    boxShadow: {
                        'glow': '0 0 15px rgba(59, 130, 246, 0.5)',
                    }
                }
            }
        }
    </script>
    
    <!-- 3. React 16 (Most stable for older WebKit) -->
    <script crossorigin src="https://unpkg.com/react@16.14.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Base Reset & iOS Specifics */
        body { 
            background-color: #f8fafc; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: pan-y;
        }
        .select-none { user-select: none; -webkit-user-select: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-top { padding-top: env(safe-area-inset-top); }
        
        /* Animations */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.2s ease-out; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .canvas-container { touch-action: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body class="select-none text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG) ---
        // We define them here to avoid import errors
        const IconVolume = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></svg>;
        const IconCheck = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12" /></svg>;
        const IconX = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>;
        const IconHeart = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></svg>;
        const IconArrowLeft = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></svg>;
        const IconEraser = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21" /><path d="M22 21H7" /><path d="m5 11 9 9" /></svg>;
        const IconHome = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const IconFlame = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.09.91-2.1 1.65-2.95a2.5 2.5 0 0 0 .35 2.75Z"/></svg>;

        // --- DATA ---
        // Hardcoded data so no external files are needed
        const TRAFFIC_LEVELS = [
            { id: 'a1', type: 'color_reaction', prompt: "Tap the correct color!", commandText: "The light is red.", targetColor: 'red', audioPrompt: "The light is red." },
            { id: 'a2', type: 'picture_choice', prompt: "What does this mean?", iconType: 'green_light', options: [{id:'o1', text:"Look! It's green now.", isCorrect:true}, {id:'o2', text:"Stop! Red light.", isCorrect:false}, {id:'o3', text:"Good morning.", isCorrect:false}].sort(() => Math.random() - 0.5) },
            { id: 'a3', type: 'build', targetSentence: "Let‚Äôs go to school.", chinese: "Êàë‰ª¨ÂéªÂ≠¶Ê†°Âêß„ÄÇ", words: ["Let‚Äôs", "go", "to", "school.", "stop"].sort(() => Math.random() - 0.5) },
            { id: 'a4', type: 'color_reaction', prompt: "Fast!", commandText: "Let's go!", targetColor: 'green', audioPrompt: "Let's go!" },
            { id: 'a5', type: 'match_pairs', prompt: "Match English and Chinese", pairs: [{id:'p1a', text:"Good morning.", lang:'en', pairId:'p1'}, {id:'p1b', text:"Êó©‰∏äÂ•Ω„ÄÇ", lang:'cn', pairId:'p1'}, {id:'p2a', text:"Stop!", lang:'en', pairId:'p2'}, {id:'p2b', text:"ÂÅúÔºÅ", lang:'cn', pairId:'p2'}, {id:'p3a', text:"It's green now.", lang:'en', pairId:'p3'}, {id:'p3b', text:"Áé∞Âú®ÊòØÁªøÁÅØ‰∫Ü„ÄÇ", lang:'cn', pairId:'p3'}].sort(() => Math.random() - 0.5) },
            { id: 'a6', type: 'build', targetSentence: "The light is red.", chinese: "Á∫¢ÁÅØ‰∫Æ‰∫Ü„ÄÇ", words: ["The", "light", "is", "red.", "green"].sort(() => Math.random() - 0.5) }
        ];

        const ALPHABET_LEVELS = [
            { id: 'b1', type: 'audio_choice', prompt: "Which letter is Q?", audioText: "Find the letter Q.", options: [{id:'o1', text:"Q", isCorrect:true}, {id:'o2', text:"P", isCorrect:false}, {id:'o3', text:"O", isCorrect:false}].sort(() => Math.random() - 0.5) },
            { id: 'b2', type: 'tracing', prompt: "Trace Uppercase Q", letter: "Q" },
            { id: 'b3', type: 'match_pairs', prompt: "Match Big and Small", pairs: [{id:'p1a', text:"Q", lang:'en', pairId:'p1'}, {id:'p1b', text:"q", lang:'en', pairId:'p1'}, {id:'p2a', text:"R", lang:'en', pairId:'p2'}, {id:'p2b', text:"r", lang:'en', pairId:'p2'}, {id:'p3a', text:"rabbit", lang:'en', pairId:'p3'}, {id:'p3b', text:"üê∞", lang:'image', pairId:'p3'}].sort(() => Math.random() - 0.5) },
            { id: 'b4', type: 'tracing', prompt: "Trace Lowercase q", letter: "q" },
            { id: 'b5', type: 'audio_choice', prompt: "Which letter makes this sound?", audioText: "/k/ /k/ /k/", options: [{id:'o1', text:"Q", isCorrect:true}, {id:'o2', text:"R", isCorrect:false}, {id:'o3', text:"S", isCorrect:false}].sort(() => Math.random() - 0.5) },
            { id: 'b9', type: 'build', targetSentence: "rabbit", chinese: "ÂÖîÂ≠ê", words: ["r", "a", "b", "b", "i", "t"].sort(() => Math.random() - 0.5) },
            { id: 'b10', type: 'missing_letter', prompt: "Complete the word", displayWord: "_uestion", correctOption: "q", options: ["q", "p", "d"].sort(() => Math.random() - 0.5) }
        ];

        const MODULES = [
            { id: 'mod_traffic', title: "Traffic Light", description: "Red, Green, Stop, Go!", themeColor: "bg-blue-500", levels: TRAFFIC_LEVELS },
            { id: 'mod_alpha', title: "Alphabet Q & R", description: "Qq, Rr, Rabbit", themeColor: "bg-purple-500", levels: ALPHABET_LEVELS }
        ];

        // --- AUDIO ENGINE ---
        const AudioEngine = {
            playDing: () => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            },
            playBoop: () => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, ctx.currentTime); 
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            },
            speak: (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                let speakText = text;
                if (text.includes('/k/')) speakText = "The sound kuh"; 
                const utterance = new SpeechSynthesisUtterance(speakText);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        };

        // --- COMPONENTS ---
        const TrafficLightRed = () => (
            <div className="w-20 h-28 md:w-32 md:h-44 bg-slate-800 rounded-2xl flex flex-col items-center justify-center p-2 border-4 border-slate-600 shadow-xl space-y-2">
                <div className="w-6 h-6 md:w-10 md:h-10 rounded-full bg-red-500 shadow-[0_0_20px_rgba(239,68,68,1)] animate-pulse" />
                <div className="w-6 h-6 md:w-10 md:h-10 rounded-full bg-slate-700/50" />
                <div className="w-6 h-6 md:w-10 md:h-10 rounded-full bg-slate-700/50" />
            </div>
        );
        const TrafficLightGreen = () => (
            <div className="w-20 h-28 md:w-32 md:h-44 bg-slate-800 rounded-2xl flex flex-col items-center justify-center p-2 border-4 border-slate-600 shadow-xl space-y-2">
                <div className="w-6 h-6 md:w-10 md:h-10 rounded-full bg-slate-700/50" />
                <div className="w-6 h-6 md:w-10 md:h-10 rounded-full bg-slate-700/50" />
                <div className="w-6 h-6 md:w-10 md:h-10 rounded-full bg-green-500 shadow-[0_0_20px_rgba(34,197,94,1)] animate-pulse" />
            </div>
        );

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('HOME');
            const [activeModule, setActiveModule] = useState(null);
            const [levelIndex, setLevelIndex] = useState(0);
            const [hearts, setHearts] = useState(5);
            const [status, setStatus] = useState('idle');
            const [progress, setProgress] = useState(0);
            
            const [buildSelected, setBuildSelected] = useState([]);
            const [buildBank, setBuildBank] = useState([]);
            const [matchSolved, setMatchSolved] = useState([]);
            const [matchSelected, setMatchSelected] = useState(null);
            const [choiceSelected, setChoiceSelected] = useState(null);
            const [canvasDrawn, setCanvasDrawn] = useState(false);
            
            const canvasRef = useRef(null);
            const isDrawing = useRef(false);

            // Safe Access for iOS 12 (avoid ?. operator)
            const currentLevel = activeModule && activeModule.levels ? activeModule.levels[levelIndex] : null;

            useEffect(() => {
                if (!currentLevel) return;
                setStatus('idle');
                setBuildSelected([]);
                setMatchSolved([]);
                setMatchSelected(null);
                setChoiceSelected(null);
                setCanvasDrawn(false);
                
                if (currentLevel.audioPrompt) {
                    setTimeout(() => AudioEngine.speak(currentLevel.audioPrompt), 500);
                } else if (currentLevel.type === 'audio_choice') {
                    setTimeout(() => AudioEngine.speak(currentLevel.audioText), 500);
                }
                
                if (currentLevel.type === 'build') {
                    setBuildBank(currentLevel.words.map((w, i) => ({ id: i, text: w, used: false })));
                }
            }, [levelIndex, currentLevel]);

            // Auto Check Match Pairs
            useEffect(() => {
                if (currentLevel && currentLevel.type === 'match_pairs') {
                    if (matchSolved.length === currentLevel.pairs.length && matchSolved.length > 0) {
                        handleSuccess();
                    }
                }
            }, [matchSolved]);

            const startModule = (mod) => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) { const ctx = new AudioContext(); ctx.resume(); }

                setActiveModule(mod);
                setLevelIndex(0);
                setHearts(5);
                setProgress(0);
                setView('GAME');
            };

            const handleSuccess = () => {
                setStatus('correct');
                AudioEngine.playDing();
                if (currentLevel && currentLevel.targetSentence) AudioEngine.speak(currentLevel.targetSentence);
            };

            const handleError = () => {
                setStatus('wrong');
                AudioEngine.playBoop();
                setHearts(h => Math.max(0, h - 1));
            };

            const nextLevel = () => {
                if (activeModule && levelIndex < activeModule.levels.length - 1) {
                    const newIndex = levelIndex + 1;
                    setLevelIndex(newIndex);
                    setProgress(((newIndex + 2) / (activeModule.levels.length + 1)) * 100);
                } else {
                    setView('FINISHED');
                    AudioEngine.playDing();
                }
            };

            const checkAnswer = () => {
                if (status !== 'idle') { nextLevel(); return; }
                if (!currentLevel) return;
                
                let isCorrect = false;
                if (currentLevel.type === 'build') {
                    const separator = currentLevel.targetSentence.indexOf(' ') >= 0 ? ' ' : '';
                    const sentence = buildSelected.join(separator);
                    isCorrect = sentence === currentLevel.targetSentence;
                } else if (currentLevel.type === 'audio_choice' || currentLevel.type === 'picture_choice') {
                    const opt = currentLevel.options.filter(o => o.id === choiceSelected)[0];
                    isCorrect = opt && opt.isCorrect;
                } else if (currentLevel.type === 'tracing') {
                    isCorrect = canvasDrawn;
                } else if (currentLevel.type === 'missing_letter') {
                    isCorrect = choiceSelected === currentLevel.correctOption;
                }

                if (isCorrect) handleSuccess(); else handleError();
            };

            // Canvas Logic
            const getCoords = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return { 
                    x: (clientX - rect.left) * (canvasRef.current.width / rect.width), 
                    y: (clientY - rect.top) * (canvasRef.current.height / rect.height) 
                };
            };

            const startDraw = (e) => {
                isDrawing.current = true;
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineWidth = 15; ctx.lineCap = 'round'; ctx.strokeStyle = '#3b82f6';
                const coords = getCoords(e);
                ctx.beginPath(); ctx.moveTo(coords.x, coords.y);
                setCanvasDrawn(true);
            };
            const draw = (e) => {
                if (!isDrawing.current) return;
                const ctx = canvasRef.current.getContext('2d');
                const coords = getCoords(e);
                ctx.lineTo(coords.x, coords.y); ctx.stroke();
            };
            const endDraw = () => { isDrawing.current = false; };
            const clearCanvas = () => {
                const ctx = canvasRef.current.getContext('2d');
                ctx.clearRect(0, 0, 600, 600);
                setCanvasDrawn(false);
            };

            // VIEWS
            if (view === 'HOME') {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4 space-y-8">
                        <div className="text-center">
                            <h1 className="text-4xl md:text-6xl font-black text-slate-700 mb-2">English Quiz</h1>
                            <p className="text-xl text-slate-400">Select a lesson</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-4xl">
                            {MODULES.map(m => (
                                <button key={m.id} onClick={() => startModule(m)} className="bg-white p-6 md:p-8 rounded-3xl border-4 border-slate-200 shadow-lg flex items-center space-x-6 text-left group active:scale-95 transition-transform">
                                    <div className={`w-20 h-20 ${m.themeColor} rounded-2xl flex items-center justify-center text-white text-3xl font-bold shadow-inner`}>Aa</div>
                                    <div>
                                        <h2 className="text-2xl md:text-3xl font-bold text-slate-700">{m.title}</h2>
                                        <p className="text-slate-400 text-lg">{m.description}</p>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'FINISHED') {
                return (
                    <div className="min-h-screen bg-white flex flex-col items-center justify-center p-4 text-center space-y-6">
                        <div className="text-8xl animate-bounce"><IconFlame className="w-32 h-32 text-orange-500 mx-auto"/></div>
                        <h1 className="text-5xl font-black text-slate-800">Great Job!</h1>
                        <button onClick={() => setView('HOME')} className="bg-blue-500 text-white px-8 py-4 rounded-full text-xl font-bold flex items-center space-x-2 active:bg-blue-600 transition-colors mx-auto">
                            <IconHome className="w-6 h-6"/> <span>Back Home</span>
                        </button>
                    </div>
                );
            }

            // GAME
            return (
                <div className="fixed inset-0 flex flex-col bg-slate-50">
                    {/* Header */}
                    <div className="h-16 bg-white border-b flex items-center px-4 justify-between shrink-0 safe-top">
                        <button onClick={() => setView('HOME')}><IconArrowLeft className="w-8 h-8 text-slate-400"/></button>
                        <div className="flex-1 h-4 bg-slate-100 rounded-full overflow-hidden mx-4">
                            <div className="h-full bg-green-500 transition-all duration-500" style={{width: progress + '%'}}></div>
                        </div>
                        <div className="flex items-center space-x-1 text-red-500 font-bold text-2xl">
                            <IconHeart className="w-8 h-8"/> <span>{hearts}</span>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto scrollbar-hide p-4 flex flex-col items-center justify-center w-full max-w-6xl mx-auto">
                        
                        {/* BUILD */}
                        {currentLevel.type === 'build' && (
                            <div className="w-full h-full flex flex-col justify-between py-4 space-y-4">
                                <div className="text-center space-y-4">
                                    <h2 className="text-2xl md:text-4xl font-bold text-slate-400">BUILD THE SENTENCE</h2>
                                    <div className="text-4xl md:text-6xl font-bold text-slate-800 flex flex-col items-center space-y-2">
                                        <span>{currentLevel.chinese}</span>
                                        <button onClick={()=>AudioEngine.speak(currentLevel.targetSentence)} className="bg-blue-100 text-blue-500 rounded-full p-2"><IconVolume className="w-6 h-6"/></button>
                                    </div>
                                </div>
                                <div className="flex flex-wrap justify-center min-h-[80px] border-b-4 border-slate-200 p-4">
                                    {buildSelected.map((w, i) => (
                                        <button key={i} onClick={() => {
                                            const newSel = [...buildSelected]; newSel.splice(i, 1); setBuildSelected(newSel);
                                            setBuildBank(prev => prev.map(bw => bw.text === w && bw.used ? { ...bw, used: false } : bw));
                                        }} className="bg-white border-2 border-slate-200 px-4 py-2 rounded-xl text-2xl md:text-4xl font-bold shadow-sm m-1">{w}</button>
                                    ))}
                                </div>
                                <div className="flex flex-wrap justify-center">
                                    {buildBank.map((item, i) => (
                                        <button key={i} onClick={() => {
                                            if(item.used) return;
                                            setBuildSelected([...buildSelected, item.text]);
                                            setBuildBank(prev => prev.map(bw => bw.id === item.id ? { ...bw, used: true } : bw));
                                            AudioEngine.speak(item.text);
                                        }} className={`px-6 py-3 m-2 rounded-xl border-b-4 text-2xl md:text-4xl font-bold transition-all ${item.used ? 'opacity-0 pointer-events-none' : 'bg-white border-slate-200 text-slate-700 active:translate-y-1'}`}>{item.text}</button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* MATCH */}
                        {currentLevel.type === 'match_pairs' && (
                            <div className="w-full h-full flex flex-col">
                                <h2 className="text-xl text-center font-bold text-slate-400 mb-4">{currentLevel.prompt}</h2>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-6 flex-1 content-center">
                                    {currentLevel.pairs.map(p => {
                                        const isSolved = matchSolved.indexOf(p.id) !== -1;
                                        const isSelected = matchSelected === p.id;
                                        return (
                                            <button key={p.id} disabled={isSolved} onClick={() => {
                                                if(isSelected) { setMatchSelected(null); return; }
                                                if(!matchSelected) { setMatchSelected(p.id); if(p.lang==='en') AudioEngine.speak(p.text); return; }
                                                const prev = currentLevel.pairs.filter(i => i.id === matchSelected)[0];
                                                if(prev && prev.pairId === p.pairId) {
                                                    setMatchSolved([...matchSolved, prev.id, p.id]); setMatchSelected(null); AudioEngine.playDing();
                                                } else {
                                                    setMatchSelected(null); AudioEngine.playBoop();
                                                }
                                            }} className={`rounded-2xl border-4 min-h-[80px] md:min-h-[140px] flex items-center justify-center p-2 text-xl md:text-4xl font-bold transition-all ${isSolved ? 'opacity-0 pointer-events-none' : isSelected ? 'bg-blue-100 border-blue-500 text-blue-600' : 'bg-white border-slate-200 text-slate-700'}`}>
                                                {p.lang === 'image' ? <span className="text-5xl md:text-7xl">{p.text}</span> : p.text}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {/* CHOICE */}
                        {(currentLevel.type === 'audio_choice' || currentLevel.type === 'picture_choice') && (
                            <div className="w-full flex flex-col items-center space-y-6 md:space-y-10">
                                <h2 className="text-2xl md:text-4xl font-bold text-slate-700 text-center">{currentLevel.prompt}</h2>
                                <div className="p-4">
                                    {currentLevel.type === 'audio_choice' && <button onClick={() => AudioEngine.speak(currentLevel.audioText)} className="w-32 h-32 md:w-48 md:h-48 bg-blue-500 rounded-full flex items-center justify-center shadow-lg active:scale-95 text-white"><IconVolume className="w-16 h-16"/></button>}
                                    {currentLevel.type === 'picture_choice' && currentLevel.iconType === 'green_light' && <TrafficLightGreen />}
                                    {currentLevel.type === 'picture_choice' && currentLevel.iconType === 'question' && <span className="text-8xl">‚ùì</span>}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 w-full">
                                    {currentLevel.options.map(opt => (
                                        <button key={opt.id} onClick={() => { setChoiceSelected(opt.id); if(opt.text) AudioEngine.speak(opt.text); }} className={`py-6 px-4 rounded-xl border-4 text-2xl md:text-3xl font-bold transition-all ${choiceSelected === opt.id ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-slate-200 text-slate-700'}`}>
                                            {opt.text}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* REACTION */}
                        {currentLevel.type === 'color_reaction' && (
                            <div className="flex flex-col items-center space-y-8 w-full">
                                <h2 className="text-4xl md:text-6xl font-black text-slate-800 animate-bounce">{currentLevel.prompt}</h2>
                                <div className="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6 w-full h-64 md:h-96">
                                    <button onClick={() => currentLevel.targetColor==='red' ? handleSuccess() : handleError()} className="flex-1 bg-red-500 rounded-3xl border-b-8 border-red-700 active:border-b-0 active:translate-y-2 flex items-center justify-center"><div className="w-24 h-24 bg-red-400 rounded-full animate-pulse"/></button>
                                    <button onClick={() => currentLevel.targetColor==='green' ? handleSuccess() : handleError()} className="flex-1 bg-green-500 rounded-3xl border-b-8 border-green-700 active:border-b-0 active:translate-y-2 flex items-center justify-center"><div className="w-24 h-24 bg-green-400 rounded-full animate-pulse"/></button>
                                </div>
                            </div>
                        )}

                        {/* TRACING */}
                        {currentLevel.type === 'tracing' && (
                            <div className="flex flex-col items-center space-y-4 w-full">
                                <h2 className="text-2xl font-bold text-slate-400">Trace the letter</h2>
                                <div className="relative bg-white rounded-3xl shadow-inner border-4 border-slate-200 overflow-hidden canvas-container" style={{width:'min(80vw, 500px)', height:'min(80vw, 500px)'}}>
                                    <div className="absolute inset-0 flex items-center justify-center text-[250px] md:text-[300px] text-slate-100 font-serif select-none pointer-events-none" style={{lineHeight:1}}>{currentLevel.letter}</div>
                                    <canvas ref={canvasRef} width={600} height={600} className="w-full h-full cursor-crosshair relative z-10"
                                        onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw}
                                        onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw}
                                    />
                                </div>
                                <button onClick={clearCanvas} className="bg-slate-200 px-6 py-2 rounded-full font-bold text-slate-600 flex items-center space-x-2"><IconEraser className="w-5 h-5"/> <span>Clear</span></button>
                            </div>
                        )}

                        {/* MISSING LETTER */}
                        {currentLevel.type === 'missing_letter' && (
                            <div className="flex flex-col items-center space-y-8">
                                <div className="flex items-end space-x-1">
                                    {currentLevel.displayWord.split('_').map((part, i) => (
                                        <React.Fragment key={i}>
                                            <span className="text-6xl md:text-8xl font-mono text-slate-400">{part}</span>
                                            {i === 0 && <span className="text-6xl md:text-8xl font-bold text-blue-500 border-b-8 border-blue-500 min-w-[3rem] text-center px-2">{choiceSelected || '?'}</span>}
                                        </React.Fragment>
                                    ))}
                                </div>
                                <div className="flex space-x-4">
                                    {currentLevel.options.map(o => (
                                        <button key={o} onClick={() => setChoiceSelected(o)} className={`w-24 h-24 rounded-2xl text-5xl font-bold border-b-8 transition-all ${choiceSelected === o ? 'bg-blue-500 border-blue-700 text-white' : 'bg-white border-slate-200 text-slate-700'}`}>{o}</button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="h-24 bg-white border-t border-slate-100 flex items-center justify-between px-6 shrink-0 safe-bottom">
                        <div className="flex-1">
                            {status === 'correct' && <div className="text-green-500 font-black text-3xl animate-bounce flex items-center space-x-2"><IconCheck className="w-8 h-8"/> <span>GOOD!</span></div>}
                            {status === 'wrong' && <div className="text-red-500 font-black text-3xl animate-shake flex items-center space-x-2"><IconX className="w-8 h-8"/> <span>TRY AGAIN</span></div>}
                        </div>
                        {currentLevel.type !== 'color_reaction' && (
                            <button onClick={checkAnswer} className={`px-10 py-4 rounded-2xl font-black text-2xl uppercase shadow-lg active:scale-95 transition-all ${status === 'idle' ? 'bg-green-500 text-white shadow-green-200' : status === 'correct' ? 'bg-blue-500 text-white' : 'bg-red-500 text-white'}`}>
                                {status === 'idle' ? 'Check' : 'Next'}
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
